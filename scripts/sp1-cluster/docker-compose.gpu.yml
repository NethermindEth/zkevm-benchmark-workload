# GPU Worker override - use with: docker compose -f docker-compose.yml -f docker-compose.gpu.yml up
services:
  sp1-gpu-worker:
    image: ${SP1_CLUSTER_GPU_IMAGE:-ghcr.io/succinctlabs/sp1-cluster:node-gpu-v1.0.4}
    command: ["/node"]
    environment:
      NODE_COORDINATOR_RPC: http://sp1-coordinator:50052
      WORKER_MAX_WEIGHT_OVERRIDE: ${GPU_WORKER_MAX_WEIGHT:-24}
      NODE_ARTIFACT_STORE: redis
      NODE_REDIS_NODES: redis://:${REDIS_PASSWORD:-}@redis:6379/0
      WORKER_TYPE: GPU
      RUST_LOG: ${RUST_LOG:-info,moongate_core=off}
      # GPU-specific settings
      CUDA_VISIBLE_DEVICES: ${CUDA_VISIBLE_DEVICES:-all}
    volumes:
      - ${HOME}/.sp1/circuits:/root/.sp1/circuits
    depends_on:
      - sp1-coordinator
      - redis
    networks:
      - sp1-network
    restart: unless-stopped
    # NVIDIA GPU runtime configuration
    runtime: nvidia
    deploy:
      resources:
        limits:
          cpus: '32'
          memory: ${GPU_WORKER_MEMORY:-24G}
        reservations:
          cpus: '8'
          memory: ${GPU_WORKER_MEMORY:-24G}
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

